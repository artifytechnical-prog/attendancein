<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin Portal â€” Attendance</title>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>
  <script>
    // Protect admin page
    if(localStorage.getItem('adminLogged') !== 'true'){
      alert('Please login as Admin.');
      window.location.href = 'admin-login.html';
    }
  </script>

  <div class="container" style="max-width:1100px">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
      <h1>Attendance Dashboard</h1>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn ghost small" onclick="seedSample()">Seed Sample</button>
        <button class="btn ghost small" onclick="clearAll()">Clear Data</button>
        <button class="btn small" onclick="exportCSV()">Export CSV</button>
        <button class="btn ghost small" onclick="logout()">Logout</button>
      </div>
    </div>

    <!-- Filters -->
    <div class="controls" style="margin-top:14px">
      <div class="left">
        <div>
          <label>From</label>
          <input id="fromDate" type="date"/>
        </div>
        <div>
          <label>To</label>
          <input id="toDate" type="date"/>
        </div>

        <div>
          <label>Month</label>
          <select id="monthSelect">
            <option value="">All</option>
          </select>
        </div>

        <div>
          <label>Year</label>
          <select id="yearSelect">
            <option value="">All</option>
          </select>
        </div>

        <div>
          <label>Search</label>
          <input id="searchTerm" type="text" placeholder="Name or phone or status"/>
        </div>

        <button class="btn small" onclick="applyFilters()">Apply</button>
        <button class="btn ghost small" onclick="resetFilters()">Reset</button>
      </div>

      <div class="right">
        <div style="text-align:right">
          <div style="color:var(--muted);font-size:0.9rem">Records:</div>
          <div id="countRecords" style="font-weight:700;color:var(--accent)"></div>
        </div>
      </div>
    </div>

    <!-- Aggregated report -->
    <h3 style="margin-top:18px">Report: Total Presents per Employee</h3>
    <div class="table-wrap">
      <table id="reportTable">
        <thead>
          <tr><th>Name</th><th>Total Presents</th><th>Last Marked</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Raw data table -->
    <h3 style="margin-top:18px">Raw Attendance Records</h3>
    <div class="table-wrap" style="margin-top:8px">
      <table id="rawTable">
        <thead>
          <tr><th>#</th><th>Date & Time</th><th>Name</th><th>Phone</th><th>Status</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <p class="footer-note">Tip: Use "Seed Sample" to add demo data for testing filters and export.</p>
  </div>

  <script>
    // Utilities
    const getRecords = () => JSON.parse(localStorage.getItem('attendanceData') || '[]');

    const formatDisplay = iso => {
      try { return new Date(iso).toLocaleString(); }
      catch(e){ return iso; }
    }

    // Populate month and year selects dynamically based on data
    function buildMonthYearOptions(){
      const selectMonth = document.getElementById('monthSelect');
      const selectYear = document.getElementById('yearSelect');
      selectMonth.innerHTML = '<option value="">All</option>';
      selectYear.innerHTML = '<option value="">All</option>';

      // gather years and months from records
      const recs = getRecords();
      const years = new Set();
      const months = new Set();
      recs.forEach(r=>{
        const d = new Date(r.timestamp);
        if(isNaN(d)) return;
        years.add(d.getFullYear());
        months.add(d.getMonth()); // 0..11
      });

      Array.from(months).sort((a,b)=>a-b).forEach(m=>{
        const opt = document.createElement('option');
        opt.value = m;
        opt.text = new Date(2000, m, 1).toLocaleString(undefined,{month:'long'});
        selectMonth.appendChild(opt);
      });

      Array.from(years).sort((a,b)=>b-a).forEach(y=>{
        const opt = document.createElement('option');
        opt.value = y;
        opt.text = y;
        selectYear.appendChild(opt);
      });
    }

    // Apply filters and refresh both tables & report
    function applyFilters(){
      buildTables();
    }

    function resetFilters(){
      document.getElementById('fromDate').value = '';
      document.getElementById('toDate').value = '';
      document.getElementById('monthSelect').value = '';
      document.getElementById('yearSelect').value = '';
      document.getElementById('searchTerm').value = '';
      buildTables();
    }

    function buildTables(){
      const recs = getRecords();
      const from = document.getElementById('fromDate').value ? new Date(document.getElementById('fromDate').value) : null;
      const to = document.getElementById('toDate').value ? new Date(document.getElementById('toDate').value) : null;
      if(to) { to.setHours(23,59,59,999); }
      const month = document.getElementById('monthSelect').value;
      const year = document.getElementById('yearSelect').value;
      const search = document.getElementById('searchTerm').value.trim().toLowerCase();

      // filtered list
      const filtered = recs.filter(r => {
        const dt = new Date(r.timestamp);
        if(isNaN(dt)) return false;

        if(from && dt < from) return false;
        if(to && dt > to) return false;
        if(month !== '' && dt.getMonth().toString() !== month) return false;
        if(year !== '' && dt.getFullYear().toString() !== year) return false;

        if(search){
          const hay = `${r.name} ${r.phone || ''} ${r.status || ''}`.toLowerCase();
          if(!hay.includes(search)) return false;
        }
        return true;
      });

      // raw table
      const rawBody = document.querySelector('#rawTable tbody');
      rawBody.innerHTML = '';
      filtered.slice().reverse().forEach((r, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${filtered.length - idx}</td>
                        <td>${formatDisplay(r.timestamp)}</td>
                        <td>${r.name}</td>
                        <td>${r.phone || ''}</td>
                        <td>${r.status || ''}</td>`;
        rawBody.appendChild(tr);
      });

      document.getElementById('countRecords').innerText = filtered.length;

      // aggregated report: count Presents per name and last marked
      const map = {};
      filtered.forEach(r=>{
        const key = r.name.trim();
        if(!map[key]) map[key] = { name: key, presents:0, last: null };
        if(r.status === 'Present') map[key].presents++;
        const t = new Date(r.timestamp);
        if(!map[key].last || t > new Date(map[key].last)) map[key].last = r.timestamp;
      });

      const reportBody = document.querySelector('#reportTable tbody');
      reportBody.innerHTML = '';
      const rows = Object.values(map).sort((a,b)=>b.presents - a.presents);
      if(rows.length === 0){
        reportBody.innerHTML = `<tr><td colspan="3" style="color:var(--muted)">No data for selected filters.</td></tr>`;
      } else {
        rows.forEach(r=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${r.name}</td><td>${r.presents}</td><td>${r.last ? formatDisplay(r.last) : '-'}</td>`;
          reportBody.appendChild(tr);
        });
      }
    }

    // Export CSV of current filtered raw table
    function exportCSV(){
      const recs = getRecords();
      if(recs.length === 0){ alert('No records to export.'); return; }

      // respect current filters (reuse filtering logic quickly)
      const from = document.getElementById('fromDate').value ? new Date(document.getElementById('fromDate').value) : null;
      const to = document.getElementById('toDate').value ? new Date(document.getElementById('toDate').value) : null;
      if(to) to.setHours(23,59,59,999);
      const month = document.getElementById('monthSelect').value;
      const year = document.getElementById('yearSelect').value;
      const search = document.getElementById('searchTerm').value.trim().toLowerCase();

      const filtered = recs.filter(r => {
        const dt = new Date(r.timestamp);
        if(isNaN(dt)) return false;
        if(from && dt < from) return false;
        if(to && dt > to) return false;
        if(month !== '' && dt.getMonth().toString() !== month) return false;
        if(year !== '' && dt.getFullYear().toString() !== year) return false;
        if(search){
          const hay = `${r.name} ${r.phone || ''} ${r.status || ''}`.toLowerCase();
          if(!hay.includes(search)) return false;
        }
        return true;
      });

      if(filtered.length === 0){ alert('No records to export with current filters.'); return; }

      const header = ['Name','Phone','Status','Timestamp','Human Date'];
      const rows = filtered.map(r => [
        `"${r.name.replace(/"/g,'""')}"`,
        `"${(r.phone||'').replace(/"/g,'""')}"`,
        `"${(r.status||'').replace(/"/g,'""')}"`,
        r.timestamp,
        `"${formatDisplay(r.timestamp)}"`
      ]);

      const csv = [header.join(','), ...rows.map(r=>r.join(','))].join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `attendance_export_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // Seed some sample data for testing
    function seedSample(){
      if(!confirm('Add sample demo attendance records?')) return;
      const now = new Date();
      const sample = [
        {name:'Asha Kumar', status:'Present', phone:'9876500011', timestamp:new Date(now.getTime() - 86400000*1).toISOString()},
        {name:'Ravi Iyer', status:'Present', phone:'9876500012', timestamp:new Date(now.getTime() - 86400000*2).toISOString()},
        {name:'Asha Kumar', status:'On Leave', phone:'9876500011', timestamp:new Date(now.getTime() - 86400000*10).toISOString()},
        {name:'Suresh B', status:'Present', phone:'9876500013', timestamp:new Date(now.getTime() - 86400000*3).toISOString()},
        {name:'Ravi Iyer', status:'Present', phone:'9876500012', timestamp:new Date(now.getTime() - 86400000*20).toISOString()},
        {name:'Meena P', status:'WFH', phone:'9876500014', timestamp:new Date(now.getTime()).toISOString()}
      ];

      const arr = JSON.parse(localStorage.getItem('attendanceData')||'[]');
      const merged = arr.concat(sample);
      localStorage.setItem('attendanceData', JSON.stringify(merged));
      alert('Sample data added.');
      buildMonthYearOptions();
      buildTables();
    }

    function clearAll(){
      if(confirm('Delete all attendance records? This cannot be undone.')){
        localStorage.removeItem('attendanceData');
        buildMonthYearOptions();
        buildTables();
      }
    }

    function logout(){
      localStorage.removeItem('adminLogged');
      window.location.href = 'C:\Users\DELL\Desktop\ARTIFY  Attendance\attendance-system\admin-login.html';
    }

    // initialization
    buildMonthYearOptions();
    buildTables();

    // update month/year options whenever page gains focus in case records changed
    window.addEventListener('focus', ()=> {
      buildMonthYearOptions();
      buildTables();
    });
  </script>
</body>
</html>
